@using Microsoft.AspNetCore.Components.Forms
@using PalmHill.BlazorChat.ApiClient
@using PalmHill.BlazorChat.Shared.Models
@using Refit
@using System.Collections.Concurrent
@inject IDialogService DialogService
@inject IJSRuntime JSRuntime
@inject ThemeControl ThemeControl
@inject BlazorChatApi BlazorChatApi

<style>
    .counterbadge-container
    {
        display:block !important;
    }

</style>

<FluentFooter Class="w-100" Style="position:fixed; bottom:15px;">
    <FluentStack Class="chat-messages input-area">
        <div class="file-input-area" @onclick="ShowAttachmentPanel">
            @*Not wrapping this in an if block. Use css to hide. FluentInputFile won't work if the element disappears from the DOM. *@

            @{
                var isProgressCssClass = ((progressPercent == 0 || progressPercent == 100) ? string.Empty : "hidden");
            }

            @if (progressPercent > 0 && progressPercent < 100)
            {
                <FluentProgressRing Style="height:32px; margin-top:6px" />
            }

            <FluentCounterBadge 
                Count="attachments.Count" 
                ShowZero="true" 
                BottomPosition="-10" 
                Class="@isProgressCssClass"
            >
                <FluentButton 
                    Id="uploadButton" 
                    
                    Class="@isProgressCssClass" 
                    IconStart="(new Icons.Regular.Size24.Attach())" 
                    Style="margin-top:6px;"
                ></FluentButton>
            </FluentCounterBadge>
        </div>
        <div style="flex-grow:1;" class="min-h-100">
            <textarea 
                placeholder="Shift+Enter for new line" 
                rows="1" 
                @ref="textAreaElement" 
                @bind="messageInput" 
                class="main-textarea" 
                @onkeyup="HandleKeyPress" 
                @bind:event="oninput"
            ></textarea>
        </div>
        <div>
            <FluentButton @ref="sendButton" 
                OnClick="Send" 
                Loading="Loading" 
                Appearance="Appearance.Accent" 
                IconStart="(new Icons.Regular.Size24.Send())" 
                Style="margin-top:6px;"></FluentButton>
        </div>
    </FluentStack>
</FluentFooter>


@code {
    [Parameter]
    public ChatComponents? UiComponents { get; set; }


    private ElementReference textAreaElement;
    private string messageInput = string.Empty;
    private FluentButton? sendButton;
    private int progressPercent = 0;
    private string progressTitle = string.Empty;
    private ConcurrentDictionary<string, AttachmentInfo> attachments = new ConcurrentDictionary<string, AttachmentInfo>();
    public UISettings UISettings { get; set; } = new UISettings();
    public List<AttachmentInfo> SelectedFiles = new List<AttachmentInfo>();
    public List<AttachmentInfo> UploadedFiles = new List<AttachmentInfo>();
    public bool Loading { get; set; } = false;
    public bool IsAttachmentMode { get; set; } = false;

    public async Task ShowSettings()
    {

        DialogParameters<UISettings> parameters = new()
            {

                Title = $"Settings",
                PrimaryAction = "Save",
                PrimaryActionEnabled = true,
                Width = "500px",
                TrapFocus = true,
                Modal = true,
                PreventScroll = true,
            };
        var currentSettingsCopy = new UISettings
            {
                FrequencyPenalty = UISettings.FrequencyPenalty,
                MaxLength = UISettings.MaxLength,
                PresencePenalty = UISettings.PresencePenalty,
                Temperature = UISettings.Temperature,
                TopP = UISettings.TopP,
                SystemMessage = UISettings.SystemMessage,
                DarkMode = UISettings.DarkMode
            };
        var dialog = await DialogService.ShowDialogAsync<ChatSettings>(currentSettingsCopy, parameters);
        var dialogResult = await dialog.Result;

        if (dialogResult?.Cancelled == true)
        {
            //Reset the theme if cancel.
            await ThemeControl.ChangeTheme(UISettings.DarkMode);
        }
        else
        {
            //Save the settings.
            UISettings = (UISettings?)dialogResult?.Data ?? new UISettings();
        }

    }

    private async Task Send()
    {
        if (UiComponents?.ChatRenderer == null)
        {
            return;
        }
        Loading = true;
        await UiComponents.ChatRenderer.Send(messageInput, UISettings);
        messageInput = string.Empty;
        StateHasChanged();
        await SizeTextArea();

    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (UiComponents?.ChatRenderer == null)
        {
            return;
        }

        if (e.Key == "Enter" && !e.ShiftKey)
        {
            await Send();
        }

        await SizeTextArea();
    }

    private async Task SizeTextArea()
    {
        await JSRuntime.InvokeVoidAsync("textAreaAdjust", textAreaElement);
    }



    private void ShowAttachmentPanel()
    {
        UiComponents!.AttachmentManager?.InfoPanel?.Toggle();
    }

    public void SetReady()
    {
        Loading = false;
        StateHasChanged();
    }

    public void SetAttachmentMode(bool enabled)
    {
        IsAttachmentMode = enabled;
        StateHasChanged();
    }
}
