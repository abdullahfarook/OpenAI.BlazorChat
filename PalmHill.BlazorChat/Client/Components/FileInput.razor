@using Microsoft.AspNetCore.Components.Forms
@using PalmHill.BlazorChat.ApiClient
@using PalmHill.BlazorChat.Shared.Models
@using Refit
@inject BlazorChatApi BlazorChatApi

<style>
    .file-upload-container {
        border: 2px dashed var(--neutral-stroke-rest);
        border-radius: 5px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        position: relative;
    }
</style>

<FluentInputFile 
                 AnchorId="MyUploadBuffer"
                 DragDropZoneVisible="true"
                 Mode="InputFileMode.Stream"
                 Multiple="true"
                 MaximumFileSize="100000"
                 OnInputFileChange="UploadFiles"
                 Class="file-upload-container">
                 
    <div>
        <h5>Drag and Drop Files</h5>
        <br />
        <FluentButton Appearance="Appearance.Accent" Id="MyUploadBuffer">
            Select Files
        </FluentButton>
    </div>
</FluentInputFile>


<FluentLabel Alignment="HorizontalAlignment.Center">
    @progressTitle
</FluentLabel>

@if (UiComponents?.ChatInput?.UploadedFiles.Any() ?? false)
{
    <h4>Pending Upload</h4>
    <div>
        @foreach (var file in UiComponents.ChatInput.UploadedFiles)
        {
                <AttachmentItemDisplay Attachment="file"></AttachmentItemDisplay>
        }
    </div>
}



@code
{
    [Parameter]
    public ChatComponents? UiComponents { get; set; }


    int? progressPercent;
    string? progressTitle;



    private async Task UploadFiles(InputFileChangeEventArgs e)
    {
        progressPercent = 10;
        var files = e.GetMultipleFiles();
        var uploadedCount = 0;
        foreach (var file in files)
        {
            var attachmentInfo = new AttachmentInfo();
            attachmentInfo.Name = file.Name;
            attachmentInfo.ConversationId = UiComponents?.ChatRenderer?.ConversationId.ToString() ?? "";
            attachmentInfo.Size = file.Size;
            attachmentInfo.ContentType = file.ContentType;
            attachmentInfo.Status = AttachmentStatus.Pending;

            UiComponents?.ChatInput?.UploadedFiles.Add(attachmentInfo);
            var stream = file.OpenReadStream(10000000);
            var streamPart = new StreamPart(stream, file.Name, file.ContentType);
            var apiResponse = await BlazorChatApi.Attachment.AddAttachment("test1z", attachmentInfo.Id, streamPart);
            // Fake for now. Should be set by websocket. When file is complted processing.
            uploadedCount++;
            progressPercent = (int)((uploadedCount / (double)files.Count()) * 100);

            if (!apiResponse.IsSuccessStatusCode)
            {
                attachmentInfo.Status = AttachmentStatus.Failed;
                continue;
            }
            attachmentInfo.Status = AttachmentStatus.Uploaded;
        }
    }
}